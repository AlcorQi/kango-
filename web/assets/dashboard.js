import{getStats,getEvents,getConfig,connectSSE,fmtTime,sevPill,safe,toast,state,getAISuggestions,getHosts,generateAI}from"./api.js?v=2";
let chart;
let lastChartSig=null;
let latestIds=new Set();
let currentHostId="";
async function loadHosts(){const sel=document.getElementById("host-filter");if(!sel)return;try{const res=await getHosts();const hosts=res?.hosts||[];sel.innerHTML='<option value="">全部机器</option>';hosts.forEach(h=>{const opt=document.createElement("option");opt.value=h;opt.textContent=h;sel.appendChild(opt)});sel.value=currentHostId}catch(e){console.error("加载机器列表失败",e)}}
async function load(){const hostId=document.getElementById("host-filter")?.value||"";currentHostId=hostId;try{const s=await getStats(undefined,hostId);document.getElementById("metric-total").textContent=String(s.total_anomalies??0);document.getElementById("metric-critical").textContent=String((s.by_severity?.critical)||0);document.getElementById("metric-last").textContent=s.last_detection?fmtTime(s.last_detection):"-";document.getElementById("metric-last-scan").textContent=s.last_scan?fmtTime(s.last_scan):"-";const labels=Object.keys(s.by_type||{});const data=Object.values(s.by_type||{});renderChart(labels,data)}catch(e){toast(e.message||"加载统计失败","error")}
const params={page:1,size:10,sort:"detected_at:desc"};if(hostId)params.host_id=hostId;try{const res=await getEvents(params);renderLatest(res.items||[])}catch(e){toast(e.message||"加载事件失败","error")}}
function renderChart(labels,data){const ctx=document.getElementById("typeChart");if(!ctx)return;const pairs=(labels||[]).map((l,i)=>[l,data?.[i]??0]).sort((a,b)=>String(a[0]).localeCompare(String(b[0])));const sig=JSON.stringify(pairs);if(lastChartSig&&lastChartSig===sig)return;lastChartSig=sig;const d={labels,datasets:[{label:"类型",data,backgroundColor:["#3a86ff","#ff006e","#fb5607","#8338ec","#3a506b","#06d6a0"]}]};if(chart){chart.data=d;chart.update();return}chart=new Chart(ctx,{type:"pie",data:d,options:{plugins:{legend:{labels:{color:"#e0e6f8"}}},onClick:(e,elements)=>{if(elements&&elements.length>0){const idx=elements[0].index;const type=labels[idx];openDrawer(type)}},onHover:(event,chartElement)=>{event.native.target.style.cursor=chartElement[0]?'pointer':'default'}}})}
let drawerChart=null;async function openDrawer(type){const drawer=document.getElementById("type-drawer");const overlay=document.getElementById("drawer-overlay");const title=document.getElementById("drawer-title");if(!drawer||!overlay)return;title.textContent=`${type} 详情`;drawer.classList.add("show");overlay.classList.add("show");try{const hostId=document.getElementById("host-filter")?.value||"";const params={types:type,size:200,sort:"detected_at:desc"};if(hostId)params.host_id=hostId;const res=await getEvents(params);const items=res.items||[];renderDrawerChart(items);renderDrawerList(items.slice(0,10))}catch(e){console.error("加载详情失败",e);toast("加载详情失败","error")}}
function closeDrawer(){const drawer=document.getElementById("type-drawer");const overlay=document.getElementById("drawer-overlay");if(drawer)drawer.classList.remove("show");if(overlay)overlay.classList.remove("show")}
function renderDrawerChart(items){const ctx=document.getElementById("drawerChart");if(!ctx)return;const buckets={};const now=new Date();for(let i=23;i>=0;i--){const d=new Date(now.getTime()-i*3600000);const k=`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')} ${String(d.getHours()).padStart(2,'0')}:00`;buckets[k]=0}items.forEach(it=>{if(!it.detected_at)return;const d=new Date(it.detected_at);const k=`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')} ${String(d.getHours()).padStart(2,'0')}:00`;if(buckets[k]!==undefined){buckets[k]++}});const labels=Object.keys(buckets);const data=Object.values(buckets);if(drawerChart){drawerChart.destroy()}
const chartCtx=ctx.getContext('2d');const gradient=chartCtx.createLinearGradient(0,0,0,200);gradient.addColorStop(0,'#ff4d4f');gradient.addColorStop(1,'#3a86ff');
drawerChart=new Chart(ctx,{type:'line',data:{labels:labels.map(l=>l.split(' ')[1]),datasets:[{label:'异常数量',data:data,borderColor:gradient,backgroundColor:'rgba(58, 134, 255, 0.1)',borderWidth:2,tension:0.4,fill:true,pointRadius:2}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false},tooltip:{mode:'index',intersect:false}},scales:{x:{grid:{display:false,color:'#2a355e'},ticks:{color:'#a7b1c9',maxTicksLimit:8}},y:{grid:{color:'#2a355e'},ticks:{color:'#a7b1c9',stepSize:1},beginAtZero:true}},interaction:{mode:'nearest',axis:'x',intersect:false}}})}
function renderDrawerList(items){const tbody=document.getElementById("drawer-list");if(!tbody)return;tbody.innerHTML="";items.forEach(it=>{const tr=document.createElement("tr");tr.innerHTML=`<td style="white-space:nowrap;color:#a7b1c9">${fmtTime(it.detected_at)}</td><td style="word-break:break-all">${safe(it.message)}</td>`;tbody.appendChild(tr)})}
document.getElementById("drawer-close")?.addEventListener("click",closeDrawer);document.getElementById("drawer-overlay")?.addEventListener("click",closeDrawer);
function renderLatest(items){const tbody=document.getElementById("latest-body");if(!tbody)return;tbody.innerHTML="";items.forEach(it=>{latestIds.add(it.id);const tr=document.createElement("tr");tr.innerHTML=`<td>${fmtTime(it.detected_at)}</td><td>${sevPill(it.severity)}</td><td>${safe(it.type)}</td><td>${safe(it.message)}</td><td>${safe(it.host_id||"")}</td><td>${safe(it.source_file)}:${safe(it.line_number)}</td>`;tbody.appendChild(tr)})}
function onSSEAnomaly(e){if(!e||!e.id)return;const hostId=document.getElementById("host-filter")?.value||"";if(hostId&&e.host_id!==hostId)return;const tbody=document.getElementById("latest-body");if(!tbody)return;if(latestIds.has(e.id))return;latestIds.add(e.id);const tr=document.createElement("tr");tr.innerHTML=`<td>${fmtTime(e.detected_at)}</td><td>${sevPill(e.severity)}</td><td>${safe(e.type)}</td><td>${safe(e.message)}</td><td>${safe(e.host_id||"")}</td><td>${safe(e.source_file||"")}</td>`;tbody.prepend(tr);tbody.querySelectorAll("tr").forEach((row,i)=>{if(i>9)row.remove()})}
async function loadAISuggestions(){const wrap=document.getElementById("ai-list");if(!wrap)return;wrap.innerHTML="<div style=\"color:#a7b1c9\">正在加载 AI 建议...</div>";try{const res=await getAISuggestions({limit:1});const items=res?.items||[];if(!items.length){wrap.innerHTML="<div style=\"color:#a7b1c9\">暂无 AI 建议</div>";return}let md=items[0].markdown||items[0].content||"";md=md.replace(/^\s*={10,}\s*$/gm, "").trim();let html;if(typeof window!=="undefined"&&window.marked){html=window.marked.parse(md);}else{html=`<pre style=\"white-space:pre-wrap\">${safe(md)}</pre>`;}wrap.innerHTML=html;}catch(e){wrap.innerHTML=`<div style="color:#ff6b6b">加载 AI 建议失败：${safe(e.message||"未知错误")}</div>`;}}
document.getElementById("btn-refresh").addEventListener("click",()=>{load()});
const aiBtn=document.getElementById("btn-ai-refresh");if(aiBtn){aiBtn.disabled=true}
const genBtn=document.getElementById("btn-ai-generate");if(genBtn){genBtn.addEventListener("click",async()=>{const wrap=document.getElementById("ai-list");if(wrap){wrap.innerHTML='<div class="loading"><span class="spinner"></span><span>正在生成 AI 建议...</span></div>'}try{genBtn.disabled=true;await generateAI({window:"PT24H"});await loadAISuggestions()}catch(e){if(wrap){wrap.innerHTML=`<div class="error">生成失败：${safe(e.message||"未知错误")}</div>`}}finally{genBtn.disabled=false}})}
const hostFilter=document.getElementById("host-filter");if(hostFilter){hostFilter.addEventListener("change",()=>{load()})}
document.addEventListener("sse:anomaly",ev=>onSSEAnomaly(ev.detail));
connectSSE();
loadHosts();
load();
loadAISuggestions();
getConfig().then(c=>{const sec=(c.ui?.auto_refresh_sec)||30;setInterval(()=>{load()},sec*1000);setInterval(()=>{loadHosts()},sec*5000)}).catch(()=>{setInterval(()=>{load()},30000);setInterval(()=>{loadHosts()},60000)})
