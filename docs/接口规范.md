# 系统异常检测接口规范 v1.0

## 文档信息
- 适用范围：实时检测 + 分布式聚合 + AI建议
- 模块覆盖：前端、应用服务层（REST/SSE）、核心业务层（检测/解析/存储/统计）、数据层、分布式Agent、AI模块
- 版本策略：所有REST路径统一前缀`/api/v1`；数据对象携带`schema_version: "1.0"`

## 通用约定
- 编码与格式：`UTF-8`，JSON字段名使用`snake_case`
- 时间标准：ISO8601（示例：`2025-01-19T14:23:45Z`），统一UTC；请求参数中允许带时区偏移
- 枚举
  - `severity`: `critical | major | minor`
  - `type`: `oom | kernel_panic | unexpected_reboot | fs_error | oops | deadlock`
- 认证与安全
  - `POST /api/v1/ingest`必须`Authorization: Bearer <token>`；其他接口可按部署策略启用鉴权
  - 速率限制建议：每主机`<=1000`事件/分钟，单次批量`<=100`条
  - 不在代码库中硬编码或写入明文密钥；部署侧提供环境变量或配置安全存储
- 错误响应（统一格式）
  ```json
  {  
    "status": 400,
    "code": "INVALID_ARGUMENT",
    "message": "parameter 'start' must be ISO8601",
    "trace_id": "8b7e8d35-...",
    "details": {"param": "start"}
  }
  ```
- 通用状态码与业务码
  - 400 `INVALID_ARGUMENT`；401 `UNAUTHORIZED`；403 `FORBIDDEN`；404 `NOT_FOUND`
  - 409 `CONFLICT`；429 `RATE_LIMITED`；500 `INTERNAL_ERROR`
- 分页与排序
  - 请求参数：`page`（默认1）、`size`（默认20，最大100）、`sort`（默认`detected_at:desc`）
  - 响应字段：`page`、`size`、`total`、`has_next`

## REST 接口规范

### 1. 事件上报（Agent → Aggregator）
- 路径：`POST /api/v1/ingest`
- 认证：`Authorization: Bearer <token>`
- 请求体（JSON）
  ```json
  {
    "schema_version": "1.0",
    "host_id": "host-a",
    "events": [
      {
        "id": "a1f2...",
        "type": "oom",
        "severity": "critical",
        "message": "Out of memory: Kill process 1234",
        "source_file": "/var/log/kern.log",
        "line_number": 1234,
        "detected_at": "2025-01-19T14:23:45Z",
        "context": {
          "pid": 1234,
          "comm": "java"
        }
      }
    ]
  }
  ```
- 响应体
  ```json
  {
    "accepted": 1,
    "rejected": 0,
    "ids": ["a1f2..."],
    "errors": []
  }
  ```
- 约束与语义
  - `events`数组长度`<=100`；单条事件字段均为必填，`context`可选
  - 服务端去重策略：基于`id`与(`host_id`,`source_file`,`line_number`,`detected_at`)组合
  - 失败重试：客户端指数退避，最多重试5次；`401`停止并刷新令牌

### 2. 全局统计
- 路径：`GET /api/v1/stats`
- 查询参数：`window`（可选，示例`PT24H`或`24h`）
- 响应体
  ```json
  {
    "schema_version": "1.0",
    "total_anomalies": 156,
    "by_severity": {"critical": 12, "major": 45, "minor": 99},
    "by_type": {
      "oom": 15,
      "kernel_panic": 2,
      "unexpected_reboot": 8,
      "fs_error": 25,
      "oops": 4,
      "deadlock": 1
    },
    "trend": [
      {"timestamp": "2025-01-19T14:00:00Z", "count": 3}
    ],
    "last_detection": "2025-01-19T14:23:45Z"
  }
  ```

### 3. 主机维度统计
- 路径：`GET /api/v1/hosts/stats`
- 查询参数：`window`（可选）
- 响应体
  ```json
  {
    "items": [
      {
        "host_id": "host-a",
        "total": 87,
        "by_severity": {"critical": 5, "major": 20, "minor": 62},
        "by_type": {"oom": 9, "fs_error": 12}
      }
    ],
    "generated_at": "2025-01-19T14:30:00Z"
  }
  ```

### 4. 历史事件查询
- 路径：`GET /api/v1/events`
- 查询参数
  - `start`、`end`（ISO8601）
  - `severity`（可重复：`critical|major|minor`）
  - `types`（逗号分隔枚举）
  - `keyword`（在`message`与`source_file`中匹配）
  - `host_id`、`page`、`size`、`sort`（如`detected_at:desc`）
- 响应体
  ```json
  {
    "items": [
      {
        "id": "a1f2...",
        "type": "oom",
        "severity": "critical",
        "message": "Out of memory: Kill process 1234",
        "source_file": "/var/log/kern.log",
        "line_number": 1234,
        "detected_at": "2025-01-19T14:23:45Z",
        "host_id": "host-a"
      }
    ],
    "page": 1,
    "size": 20,
    "total": 156,
    "has_next": true
  }
  ```

### 5. 事件详情
- 路径：`GET /api/v1/events/{id}`
- 响应体
  ```json
  {
    "id": "a1f2...",
    "type": "oom",
    "severity": "critical",
    "message": "Out of memory: Kill process 1234",
    "source_file": "/var/log/kern.log",
    "line_number": 1234,
    "detected_at": "2025-01-19T14:23:45Z",
    "host_id": "host-a",
    "context": {"pid": 1234, "comm": "java"},
    "raw_excerpt": ["..."]
  }
  ```

### 6. 配置读取/更新
- 路径：`GET /api/v1/config`
- 响应体（见下方`config.json`数据结构）

- 路径：`PUT /api/v1/config`
- 请求体（JSON）遵循`config.json` schema；不允许未知字段；数值区间校验
- 响应体：保存后的完整配置；若部分字段被拒绝，返回`400 INVALID_ARGUMENT`并附带`details`

### 7. AI建议
- 路径：`GET /api/v1/ai/suggestions`
- 查询参数：`window`（默认`PT24H`）、`types`（可选）、`host_id`（可选）、`limit`（默认10）
- 响应体
  ```json
  {
    "items": [
      {
        "type": "oom",
        "summary": "过去24小时出现多次OOM",
        "reason": "内存峰值超阈值，应用未设置限额",
        "suggestions": [
          "为进程设置内存限制",
          "分析最近部署引入的内存增长"
        ],
        "risk_level": "major",
        "related_events": ["a1f2...", "b3c4..."]
      }
    ],
    "generated_at": "2025-01-19T14:31:00Z",
    "cache_ttl_sec": 600
  }
  ```

## SSE 接口规范
- 路径：`GET /api/v1/stream`
- 请求头：`Accept: text/event-stream`
- 可选请求头：`Last-Event-ID: <event_id>`（断线重连定位）
- 响应头：`Content-Type: text/event-stream`、`Cache-Control: no-cache`、`Connection: keep-alive`
- 事件类型与格式
  - 异常事件
    ```
    id: a1f2...
    event: anomaly
    data: {"id":"a1f2...","type":"oom","severity":"critical","message":"...","detected_at":"2025-01-19T14:23:45Z","host_id":"host-a"}
    
    ```
  - 心跳事件（每15秒）
    ```
    event: ping
    data: {"ts":"2025-01-19T14:30:00Z"}
    
    ```
- 客户端行为：支持自动重连；遇`429`退避；基于`id`去重

## 数据文件规范

### 1. `data/anomalies.ndjson`
- 存储：每行独立JSON事件；按追加写入
- 单行对象（schema）
  ```json
  {
    "schema_version": "1.0",
    "id": "a1f2...",
    "type": "oom",
    "severity": "critical",
    "message": "Out of memory: Kill process 1234",
    "source_file": "/var/log/kern.log",
    "line_number": 1234,
    "detected_at": "2025-01-19T14:23:45Z",
    "host_id": "host-a",
    "processed": false
  }
  ```

### 2. `data/anomalies/YYYY-MM-DD.ndjson`
- 存储：按日滚动归档；同`anomalies.ndjson`相同schema

### 3. `data/summary.json`
- 结构
  ```json
  {
    "schema_version": "1.0",
    "date": "2025-01-19",
    "total_anomalies": 156,
    "by_severity": {"critical": 12, "major": 45, "minor": 99},
    "by_type": {"oom": 15, "kernel_panic": 2, "unexpected_reboot": 8, "fs_error": 25, "oops": 4, "deadlock": 1},
    "hosts": [
      {"host_id": "host-a", "total": 87}
    ],
    "trend": [
      {"timestamp": "2025-01-19T14:00:00Z", "count": 3}
    ]
  }
  ```

### 4. `config/config.json`
- 结构
  ```json
  {
    "schema_version": "1.0",
    "detection": {
      "log_paths": ["/var/log", "/opt/app/logs"],
      "scan_interval_sec": 60,
      "retention_days": 30,
      "enabled_detectors": ["oom", "kernel_panic", "unexpected_reboot", "fs_error", "oops", "deadlock"]
    },
    "alerts": {
      "enabled": false,
      "emails": [],
      "notify_critical": true,
      "silent_minutes": 30
    },
    "ui": {
      "auto_refresh_sec": 30,
      "page_size": 20,
      "time_format": "24h"
    },
    "security": {
      "ingest_token": "<redacted>",
      "sse_max_clients": 100
    }
  }
  ```
- 约束：`scan_interval_sec`∈[5,3600]；`retention_days`∈[1,365]；邮箱需合法格式

## 分布式 Agent 约定
- 触发：实时监听`journalctl -f`或文件尾；命中规则→打包事件
- 上报：按批次调用`POST /api/v1/ingest`；带`host_id`与鉴权令牌
- 重试与幂等：基于唯一`id`保证去重；`5xx`指数退避；`401`不重试
- 合规：避免上传敏感信息（路径脱敏可选）；大小写与编码统一

## 版本化与兼容
- REST统一`/api/v1`前缀；未来变更通过`/api/v2`与`schema_version`演进
- 对旧草案中的`/api/anomalies`与`limit`参数，提供临时别名与映射（可配置），以便平滑迁移

## 验收与测试要点
- P0：
  - `ingest`正确写入NDJSON并更新`summary.json`
  - `stats/events/config`接口稳定返回；`events`分页与过滤正确
  - `SSE`心跳与断线重连正常，事件去重无漏/重
  - `AI suggestions`在至少3类异常可用，含风险标注

## 内部模块接口规范

### Detector 插件协议
```python
from typing import Optional, Dict, Any

class DetectorPlugin:
    name: str

    def detect(self, line: str, source_file: str, line_number: int) -> Optional[Dict[str, Any]]:
        ...

class DetectorEngine:
    def __init__(self, plugins: list[DetectorPlugin]):
        ...

    def process_line(self, line: str, source_file: str, line_number: int) -> Optional[Dict[str, Any]]:
        ...
```

事件对象字段需与`data/anomalies.ndjson`一致；`DetectorPlugin.detect`返回命中的事件字典或`None`。

### Parser 接口
```python
from typing import Iterable, Tuple

class LogParser:
    def iter_lines(self, path: str) -> Iterable[Tuple[int, str]]:
        ...
```

### Storage 读写接口
```python
from typing import Dict, Any, Iterable, Optional

class StorageWriter:
    def append(self, event: Dict[str, Any]) -> None:
        ...

class StorageReader:
    def query(self, start: Optional[str], end: Optional[str], severity: list[str], types: list[str], keyword: Optional[str], host_id: Optional[str], page: int, size: int, sort: str) -> Dict[str, Any]:
        ...

class Archiver:
    def rollover(self, date: str) -> None:
        ...

    def cleanup(self, retention_days: int) -> None:
        ...
```

### Stats 统计接口
```python
from typing import Dict, Any

class StatsService:
    def compute_global(self, window: Optional[str]) -> Dict[str, Any]:
        ...

    def compute_by_host(self, window: Optional[str]) -> Dict[str, Any]:
        ...
```

### Tailer 文件尾部监听接口
```python
from typing import Callable

class EventTailer:
    def start(self, callback: Callable[[dict], None]) -> None:
        ...

    def stop(self) -> None:
        ...
```

### SSE Broker 接口
```python
class SSEBroker:
    def publish(self, event: dict) -> None:
        ...

    def ping(self) -> None:
        ...
```

### Config 管理接口
```python
class ConfigManager:
    def load(self) -> dict:
        ...

    def save(self, config: dict) -> dict:
        ...
```

与`config/config.json`结构保持一致；加载后提供只读视图供各模块使用。

### AI Provider 接口
```python
class AIProvider:
    def suggestions(self, window: str, types: list[str], host_id: str, limit: int) -> dict:
        ...
```

### ID 生成与去重
- 生成策略：`id = sha256(host_id + source_file + str(line_number) + detected_at + message)[:16]`
- 去重触发点：`StorageWriter.append`与`SSEBroker.publish`均执行去重检查

### 后端服务内部协调
- `EventTailer`→`DetectorEngine`→`StorageWriter`→`StatsService`→`SSEBroker`
- `REST /api/v1/*`经`StorageReader`与`StatsService`提供读路径；`PUT /api/v1/config`经`ConfigManager.save`

### 性能与并发约束
- `StorageReader.query`在10万行内响应<300ms；分页`size<=100`
- `SSEBroker`单实例并发客户端`<=100`；事件推送速率上限`500/s`

