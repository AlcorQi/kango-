<!DOCTYPE html>
<html>
<head>
    <title>SSE Debug Test</title>
</head>
<body>
    <h1>SSE连接调试测试</h1>
    <div id="status">等待连接...</div>
    <div id="log" style="font-family: monospace; white-space: pre-wrap; background: #f0f0f0; padding: 10px; margin: 10px 0; height: 300px; overflow-y: auto;"></div>
    
    <script>
        const status = document.getElementById('status');
        const log = document.getElementById('log');
        
        function addLog(message) {
            const timestamp = new Date().toLocaleTimeString();
            log.textContent += `[${timestamp}] ${message}\n`;
            log.scrollTop = log.scrollHeight;
        }
        
        addLog('开始SSE连接测试...');
        
        try {
            addLog('创建EventSource对象...');
            const es = new EventSource('http://localhost:8000/api/v1/stream');
            
            es.onopen = function(event) {
                status.textContent = '连接已建立';
                status.style.color = 'green';
                addLog('✓ SSE连接成功打开');
                addLog('连接状态: ' + es.readyState);
            };
            
            es.onerror = function(event) {
                status.textContent = '连接错误';
                status.style.color = 'red';
                addLog('✗ SSE连接错误');
                addLog('错误类型: ' + event.type);
                addLog('连接状态: ' + es.readyState);
                addLog('URL: ' + es.url);
                console.error('SSE Error:', event);
            };
            
            es.addEventListener('open', function(e) {
                addLog('收到open事件: ' + e.data);
            });
            
            es.addEventListener('anomaly', function(e) {
                addLog('收到anomaly事件: ' + e.data);
            });
            
            es.addEventListener('ping', function(e) {
                addLog('收到ping事件: ' + e.data);
            });
            
            es.onmessage = function(e) {
                addLog('收到消息: ' + e.data);
            };
            
            addLog('EventSource对象创建成功');
            addLog('URL: ' + es.url);
            addLog('连接状态: ' + es.readyState);
            
        } catch (e) {
            status.textContent = '创建失败: ' + e.message;
            status.style.color = 'red';
            addLog('✗ 创建EventSource失败: ' + e.message);
            console.error('创建EventSource错误:', e);
        }
    </script>
</body>
</html>